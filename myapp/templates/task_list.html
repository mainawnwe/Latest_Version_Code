{% extends 'base.html' %}

{% block body %}
  {% load static %}
  
  <br />
  <div class="container mx-auto px-4">
    {% if user.is_authenticated %}
      <!-- Title and Task Create Button Section -->
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-semibold text-gray-800 dark:text-white">
          Task List
        </h1>
        <!-- Task Create Button -->
        <a href="{% url 'task_create' %}" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all">
          <i class="fa-solid fa-plus-circle mr-2"></i>Create Task
        </a>
      </div>

      <!-- Success Message -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <span class="text-green-500">{{ message }}</span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="this.parentElement.style.display='none';">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Category Filter Buttons -->
<div class="mb-6 flex items-center space-x-4">
  <a href="{% url 'task_list' %}" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2 hover:bg-gray-400">
    All
  </a>
  {% for cat in categories %}
    <a href="{% url 'task_list' %}?category={{ cat.id }}" class="bg-blue-500 text-white px-4 py-2 rounded-lg mr-2 hover:bg-blue-600">
      {{ cat.name }}
    </a>
  {% endfor %}

  <select id="sort_by" name="sort_by" class="ml-auto bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="">Sort By</option>
    <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority</option>
    <option value="due_date" {% if sort_by == 'due_date' %}selected{% endif %}>Due Date</option>
  </select>
</div>

      <!-- Task Table -->
      <div class="overflow-x-auto bg-white dark:bg-gray-800 shadow-xl rounded-xl border border-gray-200 dark:border-gray-700">
        <table id="task-list" class="min-w-full table-auto rounded-lg overflow-hidden">
          <thead>
            <tr class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white">
              <th class="py-3 px-6 text-left border-b" data-label="Title">Title</th>
              <th class="py-3 px-6 text-left border-b" data-label="Description">Description</th>
              <th class="py-3 px-6 text-left border-b" data-label="Created At">Created At</th>
              <th class="py-3 px-6 text-left border-b" data-label="Due Date">Due Date</th>
              <th class="py-3 px-6 text-left border-b" data-label="Priority">Priority</th>
              <th class="py-3 px-6 text-left border-b" data-label="Completed">Completed</th>
              <th class="py-3 px-6 text-left border-b" data-label="Created By">Created By</th>
              <th class="py-3 px-6 text-left border-b" data-label="Action">Action</th>
            </tr>
          </thead>
          <tbody>
          {% if tasks %}
            {% for task in tasks %}
              <tr class="task-item border-b hover:bg-gray-50 dark:hover:bg-gray-700" draggable="true">
                <td class="py-3 px-6 text-lg font-semibold" data-label="Title">{{ task.title }}</td>
                <td class="py-3 px-6" data-label="Description">{{ task.description }}</td>
                <td class="py-3 px-6" data-label="Created At">{{ task.created_at|date:"F j, Y, g:i a" }}</td>
                <td class="py-3 px-6" data-label="Due Date">{{ task.due_date|date:"F j, Y, g:i a" }}</td>
                <td class="py-3 px-6" data-label="Priority">
                  {% if task.priority == "High" %}
                    <span class="inline-block bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold">High</span>
                  {% elif task.priority == "Medium" %}
                    <span class="inline-block bg-yellow-400 text-white px-3 py-1 rounded-full text-sm font-semibold">Medium</span>
                  {% else %}
                    <span class="inline-block bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">Low</span>
                  {% endif %}
                </td>
                <td class="py-3 px-6" data-label="Completed">
                  {% if task.user == request.user %}
                    <input type="checkbox" class="task-completed-checkbox" data-task-id="{{ task.id }}" {% if task.is_completed %}checked{% endif %}>
                  {% else %}
                    {% if task.is_completed %}
                      <span class="inline-block bg-green-600 text-white px-3 py-1 rounded-full text-sm font-semibold">Yes</span>
                    {% else %}
                      <span class="inline-block bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold">No</span>
                    {% endif %}
                  {% endif %}
                </td>
                <td class="py-3 px-6" data-label="Created By">{{ task.user.username }}</td>
                <td class="py-3 px-6" data-label="Action">
                  <div class="flex items-center space-x-4 text-2xl">
                    <a href="{% url 'task_detail' task.id %}" class="text-blue-500 hover:underline">ðŸ“‹</a>
                    <a href="{% url 'task_update' task.id %}" class="text-yellow-500 hover:underline"><i class="fa-solid fa-pen-to-square"></i></a>
                    {% if task.user == request.user %}
                      <form action="{% url 'delete_task' task.id %}" method="post" class="inline-block">
                        {% csrf_token %}
                        <button type="submit" class="text-red-500 hover:underline bg-transparent border-none"><i class="fa-solid fa-trash"></i></button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% if task.subtasks.all %}
                {% for subtask in task.subtasks.all %}
                  <tr class="task-item border-b hover:bg-gray-50 dark:hover:bg-gray-700 bg-gray-100 dark:bg-gray-600" draggable="true">
                    <td class="py-3 px-6 pl-12 text-lg font-semibold" data-label="Title">â†³ {{ subtask.title }}</td>
                    <td class="py-3 px-6" data-label="Description">{{ subtask.description }}</td>
                    <td class="py-3 px-6" data-label="Created At">{{ subtask.created_at|date:"F j, Y, g:i a" }}</td>
                    <td class="py-3 px-6" data-label="Due Date">{{ subtask.due_date|date:"F j, Y, g:i a" }}</td>
                    <td class="py-3 px-6" data-label="Priority">
                      {% if subtask.priority == "High" %}
                        <span class="inline-block bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold">High</span>
                      {% elif subtask.priority == "Medium" %}
                        <span class="inline-block bg-yellow-400 text-white px-3 py-1 rounded-full text-sm font-semibold">Medium</span>
                      {% else %}
                        <span class="inline-block bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">Low</span>
                      {% endif %}
                    </td>
                    <td class="py-3 px-6" data-label="Completed">
                      {% if subtask.user == request.user %}
                        <input type="checkbox" class="task-completed-checkbox" data-task-id="{{ subtask.id }}" {% if subtask.is_completed %}checked{% endif %}>
                      {% else %}
                        {% if subtask.is_completed %}
                          <span class="inline-block bg-green-600 text-white px-3 py-1 rounded-full text-sm font-semibold">Yes</span>
                        {% else %}
                          <span class="inline-block bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold">No</span>
                        {% endif %}
                      {% endif %}
                    </td>
                    <td class="py-3 px-6" data-label="Created By">{{ subtask.user.username }}</td>
                    <td class="py-3 px-6" data-label="Action">
                      <div class="flex items-center space-x-4 text-xl">
                        <a href="{% url 'task_detail' subtask.id %}" class="text-blue-500 hover:underline">ðŸ“‹</a>
                        <a href="{% url 'task_update' subtask.id %}" class="text-yellow-500 hover:underline"><i class="fa-solid fa-pen-to-square"></i></a>
                        {% if subtask.user == request.user %}
                          <form action="{% url 'delete_task' subtask.id %}" method="post" class="inline-block">
                            {% csrf_token %}
                            <button type="submit" class="text-red-500 hover:underline bg-transparent border-none"><i class="fa-solid fa-trash"></i></button>
                          </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="text-center py-4">No tasks available.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
      </div>
    {% else %}
      <div class="text-center">
        <h2 class="text-3xl font-semibold mb-4 text-gray-800">Create Your Task List</h2>
        <p class="text-lg text-gray-700 mb-6">Sign up today and start managing your tasks efficiently with a personalized daily task list!</p>
        <a href="{% url 'register' %}" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-all">Sign Up Now</a>
      </div>
    {% endif %}
  </div>
  <br><br>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.task-completed-checkbox');
    checkboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const taskId = this.getAttribute('data-task-id');
        const isCompleted = this.checked;

        fetch("{% url 'toggle_task_completion' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: new URLSearchParams({
            'task_id': taskId,
            'is_completed': isCompleted
          })
        })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            alert('Failed to update task completion status.');
            // Revert checkbox state on failure
            checkbox.checked = !isCompleted;
          }
        })
        .catch(error => {
          alert('Error updating task completion status.');
          // Revert checkbox state on error
          checkbox.checked = !isCompleted;
        });
      });
    });
  });

  // Add event listener for sort_by select
  const sortBySelect = document.getElementById('sort_by');
  if (sortBySelect) {
    sortBySelect.addEventListener('change', function() {
      const selectedSort = this.value;
      const url = new URL(window.location.href);
      if (selectedSort) {
        url.searchParams.set('sort_by', selectedSort);
      } else {
        url.searchParams.delete('sort_by');
      }
      window.location.href = url.toString();
    });
  }
</script>

{% endblock %}
